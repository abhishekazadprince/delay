<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#050507">
    <meta name="description" content="Scientific inspection tool for time-delayed causal systems.">
    <title>Assumption Inspector v2.3 [Sci-Export]</title>
    <!-- PDF GENERATION LIBRARY -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* --- CORE VARIABLES --- */
        :root { 
            --bg: #050507; 
            --panel: #0a0a0c;
            --border: #1f1f23;
            --accent: #f59e0b; 
            --accent-dim: rgba(245,158,11,0.1);
            --ideal: #10b981; 
            --real: #f59e0b; 
            --fail: #ef4444; 
            --text-main: #ededf0;
            --text-muted: #888890;
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg); 
            color: var(--text-main); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            height: 100dvh; 
            width: 100vw; 
            overflow: hidden; 
            margin: 0; 
            padding: 0; 
            display: flex; 
            flex-direction: column;
            overscroll-behavior: none; /* Critical for mobile sim interaction */
        }

        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .flex { display: flex; } 
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; } 
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 0.5rem; } 
        .gap-4 { gap: 1rem; }
        .w-full { width: 100%; } 
        .h-full { height: 100%; }
        .relative { position: relative; }
        
        /* --- VIEWS --- */
        .view-section { 
            display: none; 
            height: 100%; 
            width: 100%; 
            flex-direction: column; 
            opacity: 0; 
            transition: opacity 0.2s ease-in-out; 
            overflow: hidden;
        }
        .view-section.active { 
            display: flex; 
            opacity: 1; 
        }

        /* --- UI COMPONENTS --- */
        .glass-panel { 
            background: rgba(10,10,12,0.95); 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            backdrop-filter: blur(16px); 
        }

        .lib-card { 
            background: linear-gradient(180deg, #0f0f12, #0a0a0c); 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            padding: 16px; 
            margin-bottom: 12px; 
            cursor: pointer; 
            position: relative; 
            transition: transform 0.1s, background 0.2s;
        }
        .lib-card:active { background: #151518; transform: scale(0.98); }
        
        .tag { 
            font-size: 9px; 
            color: var(--accent); 
            border: 1px solid var(--accent-dim); 
            padding: 2px 6px; 
            border-radius: 4px; 
            text-transform: uppercase; 
            letter-spacing: 0.5px;
        }

        /* --- CONTROLS --- */
        .btn { 
            background: #15151a; 
            border: 1px solid #333; 
            color: #ccc; 
            font-size: 11px; 
            font-weight: 700; 
            font-family: monospace; 
            padding: 10px; 
            border-radius: 6px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            cursor: pointer;
            user-select: none;
        }
        .btn:active { background: #222; transform: translateY(1px); }
        .btn-icon { width: 44px; height: 44px; font-size: 16px; padding: 0; }
        
        input[type=text] { 
            width: 100%; 
            background: var(--panel); 
            border: 1px solid #333; 
            color: white; 
            padding: 12px; 
            border-radius: 6px; 
            font-size: 16px; 
            outline: none; 
        }
        input[type=text]:focus { border-color: var(--accent); }

        /* Custom Slider */
        input[type=range] { -webkit-appearance: none; background: transparent; height: 30px; width: 100%; cursor: pointer; }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; 
            height: 18px; width: 18px; 
            border-radius: 50%; 
            background: #ededf0; 
            margin-top: -7px; 
            box-shadow: 0 0 0 2px var(--bg); 
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #333; border-radius: 2px; }

        /* Toggle Switch */
        .toggle { position: relative; display: inline-block; width: 40px; height: 22px; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #222; transition: .4s; border-radius: 22px; border: 1px solid #333; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: #888; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); border-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(18px); background-color: #000; }

        /* --- SPECIAL EFFECTS --- */
        .crt::before { content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); z-index: 2; background-size: 100% 2px, 3px 100%; pointer-events: none; }
        .crt { animation: textShadow 1.6s infinite; }
        @keyframes textShadow { 0% { text-shadow: 0.438px 0 1px rgba(0,30,255,0.5), -0.438px 0 1px rgba(255,0,80,0.3), 0 0 3px; } 50% { text-shadow: 2.79px 0 1px rgba(0,30,255,0.5), -2.79px 0 1px rgba(255,0,80,0.3), 0 0 3px; } 100% { text-shadow: 0.438px 0 1px rgba(0,30,255,0.5), -0.438px 0 1px rgba(255,0,80,0.3), 0 0 3px; } }

        /* --- DEBUG & OVERLAYS --- */
        #debug-log { position: fixed; top: 0; left: 0; right: 0; background: #7f1d1d; color: #fecaca; font-size: 10px; font-family: monospace; padding: 8px; z-index: 9999; display: none; }
        canvas { touch-action: none; display: block; width: 100%; height: 100%; }
    </style>
</head>
<body>
    
    <!-- ERROR LOGGING -->
    <div id="debug-log"></div>
    
    <!-- CRT EFFECT OVERLAY -->
    <div id="crt-layer" class="crt" style="position:fixed; inset:0; pointer-events:none; z-index:999; display:none;"></div>

    <!-- VIEW 1: LIBRARY -->
    <div id="view-library" class="view-section active" style="overflow-y: auto; padding: 20px;">
        <div style="max-width: 800px; margin: 0 auto; padding-top: 40px; padding-bottom: 100px;">
            <div style="text-align: center; margin-bottom: 30px;">
                <h1 style="font-size: 2.2rem; margin-bottom: 10px; font-weight: 300; letter-spacing: -1px;">Assumption Inspector</h1>
                <p style="color: var(--text-muted); font-size: 12px; font-family: monospace;">v2.3 [Sci-Export Edition]</p>
                <div style="margin-top: 20px;">
                    <input type="text" id="lib-search" placeholder="Search (e.g. Gravity, Market)..." oninput="window.App.debouncedFilter()">
                </div>
            </div>
            <div id="lib-grid"></div>
            <div id="lib-loading" style="text-align: center; color: #444; margin-top: 40px; font-family: monospace;">Initializing Scientific Core...</div>
        </div>
    </div>

    <!-- VIEW 2: INSPECTOR (MAIN SPLIT) -->
    <div id="view-inspector" class="view-section" style="background: black;">
        <!-- NAV -->
        <nav class="flex items-center justify-between" style="height: 60px; border-bottom: 1px solid var(--border); background: var(--panel); padding: 0 10px; flex-shrink: 0;">
            <button onclick="window.App.goHome()" class="btn" style="border:none; background:transparent; padding:0; color:#888;">← LIBRARY</button>
            <span id="nav-title" style="font-size: 12px; font-weight: bold; letter-spacing: 1px; color: #ccc;">MODEL</span>
            <div class="flex gap-2">
                <div id="cfl-light" style="width:8px; height:8px; border-radius:50%; background:var(--ideal); box-shadow:0 0 5px var(--ideal); margin-top:10px;"></div>
                <button onclick="window.App.toggleDrawer()" class="btn btn-icon" style="background:transparent; border:none; color:#fff; font-size:20px;">☰</button>
            </div>
        </nav>

        <!-- SCROLLABLE CONTENT -->
        <div class="flex-col" style="flex: 1; overflow-y: auto; position: relative; -webkit-overflow-scrolling: touch;">
            
            <!-- PHYSICAL CANVAS -->
            <div id="phys-container" style="position: relative; width: 100%; height: 350px; background: #050505; flex-shrink: 0;">
                <canvas id="physCanvas"></canvas>
                <div style="position: absolute; top: 10px; right: 10px; font-family: monospace; font-size: 10px; color: #666;" id="fps-counter">60 FPS</div>
                <div style="position: absolute; bottom: 10px; left: 10px; font-family: monospace; font-size: 10px; color: #666; background: rgba(0,0,0,0.7); padding: 4px; border-radius: 4px;" id="sim-time">t=0.00s</div>
                <div id="interaction-hint" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; color: rgba(255,255,255,0.1); font-size: 10px; letter-spacing: 2px; transition: opacity 0.5s;">INTERACT TO PERTURB</div>
            </div>

            <!-- OSCILLOSCOPE -->
            <div style="height: 80px; background: #08080a; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); position: relative; flex-shrink: 0;">
                <canvas id="graphCanvas"></canvas>
                <div style="position: absolute; top: 2px; left: 4px; font-size: 8px; color: #666;">DELTA OSCILLOSCOPE</div>
            </div>

            <!-- CONTROLS -->
            <div style="padding: 16px; background: var(--panel);">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex gap-2">
                        <button onclick="window.Sim.togglePause()" class="btn btn-icon" aria-label="Pause/Play">⏯</button>
                        <button onclick="window.Sim.hardReset()" class="btn btn-icon" aria-label="Reset">↺</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="window.Sim.inject('impulse')" class="btn">IMPULSE</button>
                        <button onclick="window.Sim.inject('osc')" class="btn">OSC</button>
                    </div>
                </div>

                <!-- DELAY SLIDER -->
                <div style="margin-bottom: 20px;">
                    <div class="flex justify-between" style="font-size: 10px; color: var(--text-muted); margin-bottom: 6px;">
                        <span>SIGNAL DELAY (τ)</span><span id="delay-val" style="color: var(--accent);">0.50s</span>
                    </div>
                    <div style="position: relative; height: 30px;">
                        <input type="range" id="delay-slider" min="0" max="100" value="25" oninput="window.App.updateDelay(this.value)">
                        <div style="position: absolute; left: 0; right: 0; top: 13px; height: 4px; background: linear-gradient(90deg, #064e3b, #78350f, #7f1d1d); pointer-events: none; border-radius: 2px; z-index: -1;"></div>
                    </div>
                </div>

                <!-- INFO PANELS -->
                <div class="flex-col gap-4">
                    <div class="glass-panel" style="padding: 16px; border-left: 3px solid var(--accent);">
                        <div style="font-size: 10px; font-weight: bold; color: var(--text-muted); margin-bottom: 8px;">THE FRICTION</div>
                        <p id="info-truth" style="font-family: serif; color: #ddd; font-style: italic; font-size: 14px; margin: 0; line-height: 1.5;"></p>
                    </div>
                    <div class="glass-panel" style="padding: 16px; border-left: 3px solid #3b82f6;">
                        <div style="font-size: 10px; font-weight: bold; color: var(--text-muted); margin-bottom: 8px;">FORMALISM</div>
                        <div id="info-math" style="color: white; font-family: monospace; overflow-x: auto; white-space: nowrap;"></div>
                        <div id="info-artifacts" style="margin-top: 10px; font-size: 10px; color: var(--text-muted); font-family: monospace;"></div>
                    </div>
                </div>
                
                <!-- PEDAGOGICAL PANEL -->
                <div id="teacher-panel" class="hidden" style="margin-top: 10px; padding: 16px; background: rgba(88, 28, 135, 0.1); border: 1px solid rgba(88, 28, 135, 0.5); border-radius: 8px;">
                    <div style="font-size: 10px; font-weight: bold; color: #a855f7; margin-bottom: 4px;">PEDAGOGICAL NOTE</div>
                    <p id="teacher-note" style="color: #e9d5ff; font-size: 12px; margin: 0; font-family: serif;"></p>
                </div>
                
                <div style="height: 100px;"></div> <!-- Spacer -->
            </div>
        </div>

        <!-- SETTINGS DRAWER -->
        <div id="drawer" style="position: fixed; top: 0; right: 0; bottom: 0; width: 280px; background: #0c0c0f; border-left: 1px solid var(--border); transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 100; padding: 20px; display: flex; flex-direction: column; box-shadow: -10px 0 30px rgba(0,0,0,0.5);">
            <div class="flex justify-between items-center mb-8">
                <h3 style="color: white; margin: 0; font-size: 14px; letter-spacing: 1px;">SETTINGS</h3>
                <button onclick="window.App.toggleDrawer()" style="background: none; border: none; color: #666; font-size: 24px; cursor: pointer;">×</button>
            </div>
            <div class="flex-col gap-4">
                <button onclick="window.App.enterLab()" class="btn" style="background: var(--accent-dim); border-color: var(--accent); color: var(--accent);">⚗ ENTER FULL LAB</button>
                <div style="height: 1px; background: var(--border); margin: 10px 0;"></div>
                <div class="flex-col gap-2">
                    <label style="font-size: 10px; color: var(--text-muted);">COUPLING STRENGTH</label>
                    <input type="range" min="0.1" max="3.0" step="0.1" value="1.0" oninput="window.Sim.config.param = parseFloat(this.value)">
                </div>
                <div class="flex justify-between items-center"><span style="font-size: 12px; color: #ccc;">Teacher Mode</span><label class="toggle"><input type="checkbox" onchange="window.App.toggleTeacher(this.checked)"><span class="slider"></span></label></div>
                <div class="flex justify-between items-center"><span style="font-size: 12px; color: #ccc;">Phase Space</span><label class="toggle"><input type="checkbox" onchange="window.Renderer.togglePhase(this.checked)"><span class="slider"></span></label></div>
                <div class="flex justify-between items-center"><span style="font-size: 12px; color: #ccc;">CRT Effect</span><label class="toggle"><input type="checkbox" onchange="window.App.toggleCRT(this.checked)"><span class="slider"></span></label></div>
                
                <!-- NEW EXPORT SECTION -->
                <div style="height: 1px; background: var(--border); margin: 10px 0;"></div>
                <div style="font-size: 10px; color: var(--text-muted); margin-bottom:4px;">SCIENTIFIC EXPORT</div>
                <div class="flex gap-2">
                    <button onclick="window.Exporter.downloadCSV()" class="btn" style="flex:1; background: #064e3b; border-color: #059669; color: #a7f3d0;">CSV DATA</button>
                    <button onclick="window.Exporter.generatePDF()" class="btn" style="flex:1; background: #4338ca; border-color: #4f46e5; color: #c7d2fe;">PDF REPORT</button>
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW 3: FULL LAB -->
    <div id="view-lab" class="view-section" style="background: black;">
        <div style="position: absolute; top: 10px; left: 10px; z-index: 10;"><button onclick="window.App.goInspector()" class="btn" style="background: rgba(0,0,0,0.8);">← BACK</button></div>
        <canvas id="mainCanvas"></canvas>
        <div style="position: absolute; top: 60px; left: 10px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 6px; font-family: monospace; font-size: 12px; border: 1px solid var(--border); width: 160px; pointer-events: none;">
            <div style="color: var(--text-muted); border-bottom: 1px solid var(--border); margin-bottom: 5px;">TELEMETRY</div>
            <div class="flex justify-between"><span style="color: var(--ideal);">IDEAL</span><span id="lab-ideal">0.00</span></div>
            <div class="flex justify-between"><span style="color: var(--real);">REAL</span><span id="lab-real">0.00</span></div>
            <div class="flex justify-between" style="border-top:1px solid var(--border); margin-top:4px; padding-top:2px;"><span style="color: var(--text-muted);">STAB</span><span id="lab-stab">100%</span></div>
        </div>
    </div>

<script>
/**
 * MERGED SYSTEM ARCHITECTURE (v2.3)
 * ---------------------------------
 * 1. Logic (Sim, DB) taken from 121.html (Scientific Priority)
 * 2. UI/Events taken from 123.html (Stability/Mobile Priority)
 * 3. Bug Fixes: PointerEvents, ResizeObserver, NaN Guards, Loop Management.
 * 4. Sci-Export: PDF and CSV generation tools added.
 */

// --- GLOBAL ERROR HANDLING ---
window.onerror = function(msg, url, line) { 
    const log = document.getElementById('debug-log');
    log.style.display = 'block'; 
    log.innerHTML += `ERR: ${msg} :${line}<br>`;
    console.error(msg);
};

// --- UTILS ---
window.Utils = { 
    debounce: (f, w) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => f.apply(this, a), w); }; },
    lerp: (a, b, t) => a + (b - a) * t,
    clamp: (v, min, max) => Math.max(min, Math.min(max, v))
};

// --- SCIENTIFIC DATABASE (Preserved from 121.html) ---
window.DB = {
    "gravity": { name: "Retarded Gravitation", timeType: "Continuous", artifacts: ["Phantom Torque", "Spiral Decay"], latex: "F(t) \\propto \\frac{GM}{|r(t-\\tau)|^2}", truth: "Gravity pulls towards where the object WAS, not where it is.", teacher: "Laplace calculated gravity speed > 10^7c to avoid this instability." },
    "pid": { name: "PID Controller", timeType: "Continuous", artifacts: ["Overshoot", "Ringing"], latex: "u(t) = K_p e(t-\\tau) + K_d \\dot{e}(t-\\tau)", truth: "Sensor lag creates a feedback loop that amplifies noise.", teacher: "The #1 cause of real-world robot oscillation." },
    "hookes": { name: "Harmonic Oscillator", timeType: "Continuous", artifacts: ["Energy Injection"], latex: "\\ddot{x} = -k x(t-\\tau)", truth: "Delayed restoring force pumps energy into the system.", teacher: "Self-excitation causes dangerous machine chatter." },
    "pendulum_double": { name: "Double Pendulum", timeType: "Continuous", artifacts: ["Chaos Onset"], latex: "\\theta_{1,2}'' = f(\\theta, t-\\tau)", truth: "Micro-delays break the Lyapunov exponent instantly.", teacher: "Visualizes the Butterfly Effect in real-time." },
    "boids": { name: "Flocking (Boids)", timeType: "Agent", artifacts: ["Collision", "Disbandment"], latex: "\\vec{v}_i = \\sum f(\\vec{x}_j(t-\\tau))", truth: "Reaction time prevents tight formations, causing crashes.", teacher: "Why birds don't fly as close as mathematically possible." },
    "traffic": { name: "Traffic Waves", timeType: "Hybrid", artifacts: ["Phantom Jams"], latex: "\\dot{v}_n \\propto (V_{opt} - v_n(t-\\tau))", truth: "Brake light delay causes stop-and-go waves upstream.", teacher: "Explains traffic jams with no accidents." },
    "predator": { name: "Lotka-Volterra", timeType: "Continuous", artifacts: ["Expanding Cycles"], latex: "\\dot{x} = x(a - by(t-\\tau))", truth: "Reproduction lag creates expanding death spirals.", teacher: "Real ecosystems are less stable than simple math predicts." },
    "heat": { name: "Heat Diffusion", timeType: "Field", artifacts: ["Wave-like Heat"], latex: "\\partial_t u = \\alpha \\nabla^2 u(t-\\tau)", truth: "Standard Heat Eq implies infinite speed; delay creates waves.", teacher: "Heat acts like a wave at very short time scales." },
    "maxwell": { name: "Maxwell Wave Eq", timeType: "Field", artifacts: ["Interference"], latex: "\\square u(t-\\tau) = 0", truth: "Discrete delay creates diffraction patterns.", teacher: "Transition from Classical field to Quantum interference." },
    "market": { name: "Market Cycle", timeType: "Discrete", artifacts: ["Boom/Bust"], latex: "S_t = D(P_{t-\\tau})", truth: "Production lag causes massive boom-bust cycles.", teacher: "Explains the 'Hog Cycle' in economics." },
    "supply_chain": { name: "Supply Chain", timeType: "Discrete", artifacts: ["Bullwhip Effect"], latex: "O_t = D_t + (S - I_{t-\\tau})", truth: "Information delay causes massive inventory oscillation.", teacher: "Why you couldn't buy toilet paper in 2020." },
    "game": { name: "Iterated Dilemma", timeType: "Discrete", artifacts: ["Trust Decay"], latex: "U_i = f(s_i, s_{-i})", truth: "Delayed retaliation encourages exploitation.", teacher: "Evolution of trust requires instant feedback." },
    "neural": { name: "Neural Learning", timeType: "Discrete", artifacts: ["Gradient Noise"], latex: "w_{t+1} = w_t - \\eta \\nabla L(w_{t-\\tau})", truth: "Stale gradients prevent convergence.", teacher: "Why asynchronous training is mathematically difficult." },
    "kuramoto": { name: "Kuramoto Sync", timeType: "Network", artifacts: ["Chimera States"], latex: "\\dot{\\theta}_i = \\omega + K \\sum \\sin(\\theta_j(t-\\tau) - \\theta_i)", truth: "Delay prevents full synchronization of the network.", teacher: "Why power grids can fail if sensors are too slow." },
    "logistic": { name: "Logistic Map", timeType: "Discrete", artifacts: ["Chaos Onset"], latex: "x_{n+1} = r x_n (1-x_n)", truth: "Discrete feedback paths create chaos naturally.", teacher: "The foundation of Chaos Theory." },
    "reaction": { name: "Reaction-Diffusion", timeType: "Field", artifacts: ["Turing Patterns"], latex: "\\partial_t u = D_u \\Delta u + f(u,v_{t-\\tau})", truth: "Delay in chemical inhibition creates zebra stripes.", teacher: "How biology creates patterns from noise." },
    "quantum": { name: "Quantum Collapse", timeType: "Field", artifacts: ["Superposition"], latex: "|\\psi\\rangle \\to \\delta(x-x_0)", truth: "Measurement delay creates superposition artifacts.", teacher: "Many-Worlds vs Copenhagen interpretation." }
};

// --- SIMULATION ENGINE (Logic from 121.html, Robustness Added) ---
window.Sim = {
    running: false, 
    t: 0, 
    dt: 0.016, 
    activeKey: null, 
    rafId: null, // Track animation frame
    state: {A:null, B:null}, 
    hist: [], 
    HIST_SIZE: 600, 
    histIdx: 0,
    config: { delay: 0.5, param: 1.0 }, 
    mouse: { x: 0, y: 0, down: false }, 
    signal: { type: null, ttl: 0 },

    // Deep clone helper
    clone(o) { 
        if(!o) return o; 
        if(Array.isArray(o)) return o.map(x=>({...x})); 
        if(o.u) return {u:new Float32Array(o.u), v:new Float32Array(o.v)}; 
        return {...o}; 
    },

    // Fast copy helper
    copy(t, s) { 
        if(!s||!t) return; 
        if(s.u) { t.u.set(s.u); t.v.set(s.v); } 
        else if(Array.isArray(s)) { s.forEach((x,i)=>Object.assign(t[i],x)); } 
        else Object.assign(t,s); 
    },

    // Initialization Logic (121.html)
    makeState(k) {
        if(k==='gravity') return {x:100, y:0, vx:0, vy:3.5};
        if(k==='pid') return {x:0, v:0, err:0, integ:0};
        if(k==='hookes') return {x:100, v:0};
        if(k==='pendulum_double') return {t1:2, t2:2, v1:0, v2:0, x:0, y:0};
        if(k==='boids') return Array(15).fill(0).map(()=>({x:(Math.random()-0.5)*200, y:(Math.random()-0.5)*200, vx:(Math.random()-0.5)*20, vy:(Math.random()-0.5)*20}));
        if(k==='traffic') return Array(20).fill(0).map((_,i)=>({x:i*5, v:20}));
        if(k==='market') return {P:50, S:50, D:50};
        if(k==='supply_chain') return Array(4).fill(0).map(()=>({inv:20, order:0}));
        if(k==='game') return {scoreA:50, scoreB:50, moveA:1, moveB:1};
        if(k==='neural') return Array(10).fill(0).map(()=>({w:0.5}));
        if(k==='logistic') return {x:0.1};
        if(k==='predator') return {x:10, y:5};
        if(k==='kuramoto') return Array(12).fill(0).map(()=>({th:Math.random()*6.28, w:0.5+Math.random()}));
        if(k==='heat' || k==='reaction' || k==='maxwell' || k==='quantum') return {u: new Float32Array(60).map((_,i)=> (k==='reaction'||k==='quantum'?Math.random():Math.exp(-((i-30)**2)/20))), v: new Float32Array(60).fill(0)};
        return {x:0, v:0};
    },

    init() {
        this.t=0; 
        window.DataLog.reset();
        const k = this.activeKey || 'gravity'; // Default safety
        this.state.A = this.makeState(k); 
        this.state.B = this.makeState(k);
        // Initialize history with initial state
        this.hist = new Array(this.HIST_SIZE).fill(null).map(() => this.clone(this.state.B));
        this.histIdx = 0;
        this.signal = { type: null, ttl: 0 };
    },

    start() { 
        if(!this.running) { 
            this.running=true; 
            this.loop(); 
        } 
    },
    
    stop() { 
        this.running=false; 
        if(this.rafId) { cancelAnimationFrame(this.rafId); this.rafId = null; }
    },
    
    togglePause() { this.running ? this.stop() : this.start(); },
    
    hardReset() { 
        this.stop(); 
        this.init(); 
        window.Renderer.resize(); // Ensure canvas is ready
        this.start(); 
    },
    
    inject(type) { 
        if(!this.running) this.start(); 
        this.signal = { type: type, ttl: type === 'impulse' ? 6 : 180 }; 
    },

    // Differential Equation Solver (Strict 121.html Logic)
    solve(s, inS, isIdeal) {
        const k = this.activeKey, p = this.config.param, dt = this.dt;
        let force = 0;
        
        // Input Injection
        if(this.signal.ttl > 0 && !isIdeal) {
            if(this.signal.type === 'impulse') force = 100; else force = Math.sin(this.t * 8) * 30;
            this.signal.ttl--;
        }
        // Interaction (Mouse/Touch)
        if(this.mouse.down && this.running && !isIdeal) force += (Math.random()-0.5)*100;

        // --- PHYSICS MODELS (121.html) ---
        if(k==='gravity') {
            const r = Math.sqrt(inS.x**2 + inS.y**2); const F = -5000 * p / (Math.pow(Math.max(r,10), 3) + 1);
            s.vx += (F * inS.x + (force?force/10:0)) * dt; s.vy += (F * inS.y) * dt; s.x += s.vx * dt; s.y += s.vy * dt;
        } else if(k==='pid') {
            const err = 100 - inS.x; s.integ += err * dt;
            const u = (p*2 * err) + (p*0.5 * s.integ) + (p*4 * (err - s.err)/dt);
            s.err = err; s.v += (u - s.v*0.1 + force) * dt; s.x += s.v * dt;
        } else if(k==='hookes') {
            s.v += (-40 * (inS.x - 100) + force*5)*dt*p; s.x += s.v * dt;
        } else if(k==='pendulum_double') {
            s.v1 += (-10*Math.sin(inS.t1) + force*0.01)*dt*p; s.t1 += s.v1*dt; s.v2 += (-10*Math.sin(inS.t2))*dt*p; s.t2 += s.v2*dt;
        } else if(k==='boids') {
            const center={x:0,y:0}, vel={x:0,y:0}; (isIdeal?s:inS).forEach(b=>{center.x+=b.x;center.y+=b.y;vel.x+=b.vx;vel.y+=b.vy;});
            s.forEach((b,i)=>{ 
                let sx=0, sy=0; s.forEach(b2=>{const d=Math.sqrt((b.x-b2.x)**2+(b.y-b2.y)**2); if(d>0&&d<20){sx+=(b.x-b2.x)/d;sy+=(b.y-b2.y)/d;}});
                b.vx+=(sx*2 + (center.x/15 - b.x)*0.01)*dt*p*10; b.vy+=(sy*2 + (center.y/15 - b.y)*0.01)*dt*p*10;
                b.x+=b.vx*dt; b.y+=b.vy*dt; 
            });
        } else if(k==='traffic') {
            s.forEach((car, i) => {
                const next = inS[(i+1)%s.length]; if(!next) return;
                let dist = (next.x - (isIdeal ? s[i].x : inS[i].x)); if(dist < 0) dist += 100;
                car.v += (Math.max(0, Math.min(25, (dist - 5)*2)) - car.v) * dt * 2 * p; car.x = (car.x + car.v * dt) % 100;
            });
        } else if(k==='market') {
             const S = Math.pow(inS.P/5, 1.5) * p; s.P = Math.max(1, s.P + (100 - Math.pow(s.P/5, 1.5) - S) * 0.5 * dt); s.S = S;
        } else if(k==='supply_chain') {
            for(let i=0; i<4; i++) {
                let demand = (i===3) ? 20 + Math.sin(this.t)*5 : (isIdeal?s[i+1].order : inS[i+1].order); 
                s[i].inv += (20 - demand)*dt*p; s[i].order = Math.max(0, demand + (20-s[i].inv));
            }
        } else if(k==='game') {
            if(Math.floor(this.t*10) > Math.floor((this.t-dt)*10)) {
                s.moveA = isIdeal ? s.moveB : inS.moveB; s.moveB = isIdeal ? s.moveA : inS.moveA;
                s.scoreA += (s.moveA&&s.moveB)?3 : (s.moveA?0:5); s.scoreB += (s.moveB&&s.moveA)?3 : (s.moveB?0:5);
            }
        } else if(k==='neural') {
            s.forEach((n,i) => { const grad = 2 * ((isIdeal?n.w:inS[i].w) - 0.8); n.w -= grad * 0.1 * p * dt; });
        } else if(k==='logistic') { 
            if(Math.random()<0.1) s.x = (3.5 + p*0.4) * inS.x * (1 - inS.x); 
        } else if(k==='kuramoto') {
            s.forEach((osc, i) => { let c=0; (isIdeal?s:inS).forEach(o=>c+=Math.sin(o.th-osc.th)); osc.th += (osc.w + p*c/12)*dt; });
        } else if(k==='predator') {
            s.x += (s.x * (2 - 1 * (isIdeal?s.y:inS.y))) * dt * p; s.y += (s.y * (1 * (isIdeal?s.x:inS.x) - 3)) * dt * p;
        } else if(k==='heat'||k==='reaction'||k==='maxwell'||k==='quantum') {
             for(let i=1; i<59; i++) {
                const lap = inS.u[i+1] + inS.u[i-1] - 2*inS.u[i];
                if(k==='heat') { s.v[i] += (lap - 0.1*s.v[i])*dt*50*p; }
                else if(k==='maxwell') { s.v[i] += lap*dt*50*p; } 
                else if(k==='quantum') { s.v[i] += lap*dt*50*p; if(Math.random()<0.001) s.u[i] = (Math.random()-0.5); }
                else { const uvv = s.u[i]*inS.v[i]**2; s.u[i] += (0.2*lap - uvv + 0.04*(1-s.u[i]))*dt*10*p; s.v[i] += (0.1*(s.v[i+1]+s.v[i-1]-2*s.v[i]) + uvv - 0.1*s.v[i])*dt*10*p; }
                s.u[i] += s.v[i] * dt;
            }
        }
    },

    step() {
        const steps = 2; 
        for(let i=0; i<steps; i++) {
            // Calculate delay index
            const delayFrames = Math.floor((this.config.delay / this.dt) * steps);
            let idx = (this.histIdx - delayFrames) % this.HIST_SIZE; 
            if(idx < 0) idx += this.HIST_SIZE;
            
            // Core Scientific Integration
            // A = Ideal (Instant feedback: inS is itself)
            // B = Real (Delayed feedback: inS is hist[idx])
            this.solve(this.state.A, this.state.A, true); 
            this.solve(this.state.B, this.hist[idx], false);
            
            // History Management
            this.copy(this.hist[this.histIdx], this.state.B); 
            this.histIdx = (this.histIdx + 1) % this.HIST_SIZE; 
            this.t += (this.dt / steps);
        }

        // --- STABILITY & TELEMETRY ---
        const vA = this.getScalar(this.state.A);
        const vB = this.getScalar(this.state.B);
        
        // Safety Valve (Improvements from 123.html)
        if(!isFinite(vB) || Math.abs(vB) > 50000 || isNaN(vB)) { 
            console.warn("Instability detected. Soft reset.");
            this.init(); // Auto-reset instead of just stopping
            return;
        }
        
        window.DataLog.push(this.t, vA, vB);
        this.updateUI(vA, vB);
    },

    getScalar(s) {
        if(!s) return 0;
        if(s.x!==undefined && s.vx===undefined) return s.x;
        if(s.x!==undefined) return s.x; if(s.P!==undefined) return s.P;
        if(Array.isArray(s)) { if(s[0].x!==undefined) return s.reduce((a,b)=>a+b.v,0)/s.length; if(s[0].th!==undefined) return Math.sin(s[0].th); return s[0].w || s[0].inv || 0; }
        if(s.u) return s.u[30]; return s.scoreA ? s.scoreA-s.scoreB : 0;
    },

    updateUI(vA, vB) {
        if(Math.floor(this.t*60)%10 !== 0) return; // Throttle UI updates
        const diff = Math.abs(vA - vB);
        const stab = Math.max(0, 100 - diff * (this.activeKey==='gravity'?0.2:2));
        
        const elTime = document.getElementById('sim-time');
        const elIdeal = document.getElementById('lab-ideal');
        const elReal = document.getElementById('lab-real');
        const elStab = document.getElementById('lab-stab');
        
        if(elTime) elTime.innerText = `t = ${this.t.toFixed(2)}s`;
        if(elIdeal) elIdeal.innerText = vA.toFixed(2);
        if(elReal) elReal.innerText = vB.toFixed(2);
        if(elStab) { elStab.innerText = stab.toFixed(0) + '%'; elStab.style.color = stab < 50 ? '#ef4444' : '#10b981'; }
        
        const cfl = document.getElementById('cfl-light');
        if(cfl) cfl.style.background = stab > 80 ? '#10b981' : '#ef4444';
        
        // Hide interaction hint if running
        const hint = document.getElementById('interaction-hint');
        if(hint) hint.style.opacity = this.running ? 0.2 : 1.0;
    },

    loop() {
        if(!this.running) return;
        this.step(); 
        window.Renderer.draw(); 
        this.rafId = requestAnimationFrame(()=>this.loop());
    }
};

window.DataLog = {
    buffer: new Float32Array(3000), 
    timeLog: new Float32Array(1000), // Separate buffer to store Time without breaking Renderer's expected stride
    head: 0,
    reset() { this.buffer.fill(0); this.timeLog.fill(0); this.head = 0; },
    push(t, a, b) { 
        if(!isFinite(t)) return; 
        const i = this.head * 3; 
        this.buffer[i]=a; this.buffer[i+1]=b; this.buffer[i+2]=a-b; 
        this.timeLog[this.head] = t; // Store time separately for export
        this.head = (this.head+1) % 1000; 
    },
    getTrace() { return { buf: this.buffer, head: this.head }; },
    
    // New Method for Exporting
    getExportData() {
        const len = 1000;
        const rows = [];
        // Reconstruct timeline from Ring Buffer
        for(let i=0; i<len; i++) {
            const idx = (this.head + i) % len;
            const t = this.timeLog[idx];
            if(t === 0 && i < len - 100) continue; // Skip empty prefix
            const bIdx = idx * 3;
            rows.push({
                t: t,
                ideal: this.buffer[bIdx],
                real: this.buffer[bIdx+1],
                delta: this.buffer[bIdx+2]
            });
        }
        return rows;
    }
};

// --- NEW EXPORTER MODULE ---
window.Exporter = {
    downloadCSV() {
        const data = window.DataLog.getExportData();
        if(data.length === 0) { alert("No simulation data to export."); return; }
        
        let csv = "Time (s),Ideal State,Real State (Delayed),Delta\n";
        data.forEach(r => {
            csv += `${r.t.toFixed(4)},${r.ideal.toFixed(4)},${r.real.toFixed(4)},${r.delta.toFixed(4)}\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `inspector_data_${window.Sim.activeKey}_${Date.now()}.csv`;
        a.click();
        URL.revokeObjectURL(url);
    },

    generatePDF() {
        const { jsPDF } = window.jspdf;
        if(!jsPDF) { alert("PDF Library not loaded."); return; }

        const doc = new jsPDF();
        const data = window.DataLog.getExportData();
        const model = window.DB[window.Sim.activeKey];
        
        // --- 1. Header ---
        doc.setFillColor(5, 5, 7);
        doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(22);
        doc.text("Assumption Inspector", 15, 20);
        doc.setFontSize(10);
        doc.setTextColor(200, 200, 200);
        doc.text("Scientific Report v2.3", 15, 30);
        
        // --- 2. Model Metadata ---
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(14);
        doc.text(`Model: ${model.name}`, 15, 55);
        
        doc.setFontSize(10);
        doc.setTextColor(100, 100, 100);
        doc.text(`Timestamp: ${new Date().toLocaleString()}`, 15, 62);
        doc.text(`Time Type: ${model.timeType}`, 15, 68);
        doc.text(`Artifacts: ${model.artifacts.join(", ")}`, 15, 74);
        
        // --- 3. Configuration ---
        doc.setDrawColor(200, 200, 200);
        doc.line(15, 80, 195, 80);
        doc.setFontSize(12);
        doc.setTextColor(0,0,0);
        doc.text("Simulation Parameters", 15, 90);
        doc.setFontSize(10);
        doc.text(`Delay (tau): ${window.Sim.config.delay.toFixed(2)}s`, 15, 100);
        doc.text(`Coupling Strength: ${window.Sim.config.param.toFixed(2)}`, 80, 100);
        doc.text(`Duration Recorded: ${data.length > 0 ? (data[data.length-1].t - data[0].t).toFixed(2) : 0}s`, 140, 100);

        // --- 4. Statistics ---
        let maxDelta = 0;
        let mse = 0;
        data.forEach(d => {
            const absD = Math.abs(d.delta);
            if(absD > maxDelta) maxDelta = absD;
            mse += (d.delta * d.delta);
        });
        mse = data.length ? (mse / data.length) : 0;
        
        doc.text(`Max Deviation: ${maxDelta.toFixed(4)}`, 15, 106);
        doc.text(`Mean Squared Error: ${mse.toFixed(4)}`, 80, 106);

        // --- 5. Visual Snapshot ---
        doc.text("Oscilloscope Trace", 15, 125);
        const canvas = document.getElementById('graphCanvas');
        if(canvas) {
            // Create a temporary white canvas to avoid black background in PDF
            const tmpCanvas = document.createElement('canvas');
            tmpCanvas.width = canvas.width;
            tmpCanvas.height = canvas.height;
            const ctx = tmpCanvas.getContext('2d');
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0,0,tmpCanvas.width, tmpCanvas.height);
            ctx.drawImage(canvas, 0, 0);
            
            try {
                const imgData = tmpCanvas.toDataURL("image/jpeg", 0.8);
                doc.addImage(imgData, 'JPEG', 15, 130, 180, 60);
            } catch(e) {
                doc.text("(Visual snapshot unavailable - Tainted Canvas)", 15, 140);
            }
        }

        // --- 6. Mathematical Note ---
        doc.setFillColor(245, 245, 250);
        doc.rect(15, 200, 180, 30, 'F');
        doc.setFontSize(10);
        doc.setTextColor(50, 50, 50);
        doc.text("Mathematical Formalism:", 20, 210);
        doc.setFont("courier");
        doc.text(model.latex, 20, 220);
        
        // --- 7. Pedagogical Note ---
        doc.setFont("helvetica", "italic");
        doc.setFontSize(9);
        doc.setTextColor(100, 100, 100);
        doc.text(`"${model.truth}"`, 105, 270, { align: "center" });

        doc.save(`inspector_report_${window.Sim.activeKey}.pdf`);
    }
};

window.Renderer = {
    showPhase: false, 
    togglePhase(v) { this.showPhase = v; },
    
    // Robust Resizer (New in v3)
    resize() {
        const canvases = ['physCanvas', 'mainCanvas', 'graphCanvas'];
        canvases.forEach(id => {
            const c = document.getElementById(id);
            if(!c) return;
            const rect = c.parentElement.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            c.width = rect.width * dpr;
            c.height = rect.height * dpr;
            // Prevent styling issues
            c.style.width = '100%';
            c.style.height = '100%';
        });
        this.draw();
    },

    draw() {
        const isLab = document.getElementById('view-lab').classList.contains('active');
        const c = isLab ? document.getElementById('mainCanvas') : document.getElementById('physCanvas');
        const cg = document.getElementById('graphCanvas'); 
        
        if(!c || !window.Sim.state.A) return;
        
        const ctx = c.getContext('2d'); 
        const w = c.width, h = c.height, cx = w/2, cy = h/2;
        const dpr = window.devicePixelRatio || 1;

        // Clear
        ctx.fillStyle = this.showPhase ? 'rgba(5,5,7,0.1)' : '#050507'; 
        ctx.fillRect(0,0,w,h);
        
        ctx.save(); 
        ctx.translate(cx, cy); 
        ctx.scale(dpr, dpr); 
        
        const k = window.Sim.activeKey; 

        // Drawing Entity (Logic from 121.html)
        const drawEntity = (s, col) => {
            ctx.fillStyle = col; ctx.strokeStyle = col;
            if(k === 'gravity') { ctx.beginPath(); ctx.arc(s.x, s.y, 6, 0, 7); ctx.fill(); } 
            else if(k === 'pid') { ctx.fillRect(-100, -10, 200, 20); ctx.fillStyle='#fff'; ctx.fillRect(s.x-100-5, -15, 10, 30); }
            else if(k === 'hookes') { ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(s.x-100, 0); ctx.stroke(); ctx.beginPath(); ctx.arc(s.x-100, 0, 8, 0, 7); ctx.fill(); }
            else if(k === 'pendulum_double') { const l=50; const x1=l*Math.sin(s.t1), y1=l*Math.cos(s.t1), x2=x1+l*Math.sin(s.t2), y2=y1+l*Math.cos(s.t2); ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke(); }
            else if(k === 'boids') { s.forEach(b => { ctx.fillRect(b.x, b.y, 3, 3); }); }
            else if(k === 'traffic') { const r=80; ctx.strokeStyle='#333'; ctx.beginPath(); ctx.arc(0,0,r,0,7); ctx.stroke(); s.forEach(c=>{ const a=c.x/100*6.28; ctx.beginPath(); ctx.arc(Math.cos(a)*r, Math.sin(a)*r, 4, 0, 7); ctx.fill(); }); }
            else if(k === 'market') { ctx.fillRect(-50, 0, 40, -(s.P-50)*2); ctx.beginPath(); ctx.arc(50, -(s.S-50)*2, 5, 0, 7); ctx.fill(); }
            else if(k === 'supply_chain') { s.forEach((n,i)=>ctx.fillRect((i-2)*40, 0, 30, -n.inv*2)); }
            else if(k === 'game') { ctx.fillText(s.scoreA, -50, 0); ctx.fillText(s.scoreB, 50, 0); }
            else if(k === 'neural') { s.forEach((n,i)=>ctx.fillRect((i-5)*20, 0, 15, -n.w*50)); }
            else if(s.u) { const bw=200/60; s.u.forEach((val, i) => { ctx.fillRect((i-30)*bw, 50, bw+0.5, -val*50); }); }
        };

        if(this.showPhase) {
            const plot = (s, col) => { let x=(s.x||0)*2, y=(s.v||0)*2; if(s.P!==undefined){x=(s.P-50)*2;y=(s.S-50)*2;} ctx.fillStyle=col; ctx.beginPath(); ctx.arc(x, -y, 2, 0, 7); ctx.fill(); };
            plot(window.Sim.state.A, '#10b981'); plot(window.Sim.state.B, '#f59e0b');
        } else {
            ctx.globalAlpha = 0.4; drawEntity(window.Sim.state.A, '#10b981');
            ctx.globalAlpha = 1.0; drawEntity(window.Sim.state.B, '#f59e0b');
        }
        ctx.restore();

        // Oscilloscope Draw
        if(cg && cg.width > 0) {
            const ctxG = cg.getContext('2d'); 
            const wG = cg.width, hG = cg.height; 
            ctxG.clearRect(0,0,wG,hG);
            
            const {buf, head} = window.DataLog.getTrace(); 
            const len = 1000, stepX = wG / len;
            ctxG.lineWidth = 2 * dpr;
            
            const plotLine = (offset, color) => {
                ctxG.beginPath(); ctxG.strokeStyle = color; let first = true;
                for(let i=0; i<len; i++) {
                    const idx = ((head + i) % len) * 3; 
                    const val = buf[idx + offset]; 
                    if(val === 0 && i < 10) continue;
                    let y = (hG/2) - (val * (window.Sim.activeKey==='gravity'?0.2:2) * dpr); 
                    y = Math.max(5, Math.min(hG-5, y));
                    if(first) { ctxG.moveTo(i*stepX, y); first=false; } else ctxG.lineTo(i*stepX, y);
                }
                ctxG.stroke();
            };
            plotLine(0, '#10b98144'); // Ideal
            plotLine(1, '#f59e0b');   // Real
            plotLine(2, '#ef4444');   // Delta
            
            ctxG.strokeStyle = '#333'; ctxG.lineWidth=1; 
            ctxG.beginPath(); ctxG.moveTo(0, hG/2); ctxG.lineTo(wG, hG/2); ctxG.stroke();
        }
    }
};

window.App = {
    debouncedFilter: window.Utils.debounce(() => window.App.filterLibrary(), 200),
    
    goHome() { 
        window.Sim.stop(); 
        toggleView('view-library'); 
    },
    
    enterLab() { 
        toggleView('view-lab'); 
        window.Renderer.resize(); 
    },
    
    goInspector() { 
        toggleView('view-inspector'); 
        window.Renderer.resize(); 
    },
    
    updateDelay(v) { 
        document.getElementById('delay-val').innerText = ((v/100)*2).toFixed(2)+'s'; 
        window.Sim.config.delay = (v/100)*2; 
    },
    
    toggleDrawer() { 
        const el = document.getElementById('drawer'); 
        el.style.transform = el.style.transform === 'translateX(0%)' ? 'translateX(100%)' : 'translateX(0%)'; 
    },
    
    toggleTeacher(a) { document.getElementById('teacher-panel').classList.toggle('hidden', !a); },
    toggleCRT(a) { document.getElementById('crt-layer').style.display = a ? 'block' : 'none'; },
    
    loadModel(k) { 
        window.Sim.stop(); 
        toggleView('view-inspector'); 
        
        window.Sim.activeKey = k; 
        window.Sim.init(); 
        window.Renderer.resize(); // Critical for first load
        window.Sim.start(); 
        
        const m = window.DB[k]; 
        document.getElementById('nav-title').innerText = m.name.toUpperCase(); 
        document.getElementById('info-truth').innerText = `"${m.truth}"`; 
        document.getElementById('info-math').innerText = m.latex; 
        document.getElementById('info-artifacts').innerText = m.artifacts.join(", "); 
        document.getElementById('teacher-note').innerText = m.teacher; 
    },
    
    filterLibrary() {
        if(typeof window.DB === 'undefined') { setTimeout(window.App.filterLibrary, 200); return; }
        const grid = document.getElementById('lib-grid'); 
        grid.innerHTML = ''; 
        document.getElementById('lib-loading').style.display = 'none';
        
        const q = document.getElementById('lib-search').value.toLowerCase();
        Object.entries(window.DB).forEach(([k, m]) => {
            if(q && !m.name.toLowerCase().includes(q) && !m.artifacts.join('').toLowerCase().includes(q)) return;
            const div = document.createElement('div'); div.className = 'lib-card'; div.onclick = () => window.App.loadModel(k);
            div.innerHTML = `<div class="flex justify-between" style="margin-bottom:8px;"><span class="tag">${m.timeType}</span></div><h3 style="margin:0; font-size:1.1rem; color:#eee;">${m.name}</h3><div style="font-size:10px; color:#666; margin-top:8px;">${m.truth}</div>`;
            grid.appendChild(div);
        });
    }
};

function toggleView(id) { 
    document.querySelectorAll('.view-section').forEach(e => { 
        e.classList.remove('active'); 
        e.style.opacity = 0; 
    }); 
    const el = document.getElementById(id); 
    el.classList.add('active'); 
    setTimeout(() => el.style.opacity = 1, 50); 
    
    if(id==='view-library') document.getElementById('drawer').style.transform = 'translateX(100%)'; 
}

// --- UNIFIED INPUT HANDLING (POINTER EVENTS) ---
// Replaces mouse/touch split from 123.html with robust PointerEvents
const attachInput = (id) => {
    const c = document.getElementById(id);
    if(!c) return;

    // Use Pointer Events for unified touch/mouse support
    c.addEventListener('pointerdown', (e) => {
        c.setPointerCapture(e.pointerId);
        window.Sim.mouse.down = true;
        updateMouse(e, c);
    });

    c.addEventListener('pointermove', (e) => {
        if(window.Sim.mouse.down) updateMouse(e, c);
    });

    c.addEventListener('pointerup', (e) => {
        window.Sim.mouse.down = false;
        c.releasePointerCapture(e.pointerId);
    });
    
    c.addEventListener('pointercancel', (e) => {
        window.Sim.mouse.down = false;
    });
};

const updateMouse = (e, c) => {
    const rect = c.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    // Calculate position relative to canvas
    window.Sim.mouse.x = (e.clientX - rect.left); // Physics uses logic coords
    window.Sim.mouse.y = (e.clientY - rect.top);
};

// --- LIFECYCLE MANAGEMENT ---
window.addEventListener('resize', window.Utils.debounce(() => window.Renderer.resize(), 200));

// Init
window.App.filterLibrary(); 
attachInput('physCanvas'); 
attachInput('mainCanvas');

// Initial resize to ensure canvas isn't 0x0
setTimeout(() => window.Renderer.resize(), 100);

</script>

<script src="https://cdn.tailwindcss.com"></script>
</body>
</html>
